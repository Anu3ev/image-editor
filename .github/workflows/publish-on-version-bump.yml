name: Publish & Release on version bump

on:
  push:
    branches:
      - master
    paths:
      - 'package.json'

permissions:
  contents: write   # –Ω—É–∂–Ω–æ, —á—Ç–æ–±—ã workflow –º–æ–≥ —Å–æ–∑–¥–∞–≤–∞—Ç—å —Ç—ç–≥–∏ –∏ —Ä–µ–ª–∏–∑—ã

jobs:
  publish-and-release:
    runs-on: ubuntu-latest

    steps:
      # 1. –ü—Ä–æ–≤–µ—Ä—è–µ–º, —á—Ç–æ workflow —É–º–µ–µ—Ç –ø—É—à–∏—Ç—å —Ç—ç–≥–∏
      - name: Checkout repo
        uses: actions/checkout@v3
        with:
          fetch-depth: 0    # –ø–æ–¥—Ç—è–≥–∏–≤–∞–µ–º –≤–µ—Å—å history, —á—Ç–æ–±—ã git –º–æ–≥ —Ä–∞–±–æ—Ç–∞—Ç—å —Å —Ç—ç–≥–∞–º–∏

      # 2. –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º Node.js –∏ npm-—Ç–æ–∫–µ–Ω (–¥–ª—è –ø—É–±–ª–∏–∫–∞—Ü–∏–∏ –≤ npm)
      - name: Setup Node.js and auth
        uses: actions/setup-node@v3
        with:
          node-version: 18
          registry-url: https://registry.npmjs.org
          scope: '@anu3ev'
          always-auth: true
          auth-token: ${{ secrets.NPM_TOKEN }}

      # 3. –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏
      - name: Install deps
        run: npm ci

      # 4. –°–æ–±–∏—Ä–∞–µ–º –ø—Ä–æ–µ–∫—Ç (vite build ‚Üí –Ω–∞–ø–æ–ª–Ω—è–µ—Ç dist/)
      - name: Build
        run: npm run build

      # 5. –ü—Ä–æ–≤–µ—Ä—è–µ–º, –∏–∑–º–µ–Ω–∏–ª—Å—è –ª–∏ version –≤ –ø–æ—Å–ª–µ–¥–Ω–µ–º –∫–æ–º–º–∏—Ç–µ
      - name: Check package.json version bump
        id: check_bump
        run: |
          # –ï—Å–ª–∏ package.json –Ω–µ –º–µ–Ω—è–ª—Å—è ‚Äî –≤—ã—Ö–æ–¥–∏–º –±–µ–∑ –æ—à–∏–±–æ–∫ (exit 0)
          git diff --quiet HEAD^ HEAD -- package.json && {
            echo "package.json –Ω–µ –º–µ–Ω—è–ª—Å—è ‚Äî –ø—Ä–æ–ø—É—Å–∫–∞–µ–º –≤—Å—ë";
            echo "should_publish=false" >> $GITHUB_OUTPUT
            exit 0
          }

          # –ï—Å–ª–∏ package.json –º–µ–Ω—è–ª—Å—è, –Ω–æ –≤ –Ω—ë–º –Ω–µ—Ç "version": ‚Äî —Ç–æ–∂–µ –ø—Ä–æ–ø—É—Å–∫–∞–µ–º
          if git diff HEAD^ HEAD -- package.json | grep -q '"version":'; then
            echo "–û–±–Ω–∞—Ä—É–∂–µ–Ω bump –≤–µ—Ä—Å–∏–∏ –≤ package.json"
            echo "should_publish=true" >> $GITHUB_OUTPUT
          else
            echo "package.json –º–µ–Ω—è–ª—Å—è, –Ω–æ –≤–µ—Ä—Å–∏—è –æ—Å—Ç–∞–ª–∞—Å—å –ø—Ä–µ–∂–Ω–µ–π ‚Äî –ø—Ä–æ–ø—É—Å–∫–∞–µ–º"
            echo "should_publish=false" >> $GITHUB_OUTPUT
          fi

      # 6. –ü—É–±–ª–∏–∫—É–µ–º –≤ npm –∏ —Å–æ–∑–¥–∞—ë–º —Ä–µ–ª–∏–∑ —Ç–æ–ª—å–∫–æ –µ—Å–ª–∏ version –¥–µ–π—Å—Ç–≤–∏—Ç–µ–ª—å–Ω–æ bumped
      - name: Publish to npm and create GitHub Release
        if: steps.check_bump.outputs.should_publish == 'true'
        run: |
          # 6.1. –ß–∏—Ç–∞–µ–º –≤–µ—Ä—Å–∏—é –∏–∑ package.json
          VERSION=$(node -p "require('./package.json').version")
          TAG="v${VERSION}"

          # 6.2. –ü—É–±–ª–∏–∫—É–µ–º –≤ npm (—Å –ø—É–±–ª–∏—á–Ω—ã–º –¥–æ—Å—Ç—É–ø–æ–º)
          echo "‚ñ∫ –ü—É–±–ª–∏–∫–∞—Ü–∏—è –ø–∞–∫–µ—Ç–∞ –≤ npm (version=${VERSION})"
          npm publish --access public

          # 6.3. –ü—Ä–æ–≤–µ—Ä—è–µ–º, –µ—Å—Ç—å –ª–∏ —É–∂–µ —Ç–∞–∫–æ–π —Ç—ç–≥ –≤ —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏–∏
          if git rev-parse "$TAG" >/dev/null 2>&1; then
            echo "–¢—ç–≥ $TAG —É–∂–µ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç ‚Üí –ø—Ä–æ–ø—É—Å–∫–∞–µ–º –µ–≥–æ —Å–æ–∑–¥–∞–Ω–∏–µ"
          else
            echo "–°–æ–∑–¥–∞—ë–º –Ω–æ–≤—ã–π —Ç—ç–≥ $TAG –∏ –ø—É—à–∏–º –≤ —Ä–µ–ø–æ"
            git config user.name "github-actions[bot]"
            git config user.email "github-actions[bot]@users.noreply.github.com"
            git tag "$TAG"
            git push origin "$TAG"
          fi

          # 6.4. –ü–æ–º–µ—á–∞–µ–º –≤–µ—Ä—Å–∏—é –¥–ª—è –ø–µ—Ä–µ–¥–∞—á–∏ –≤ —Å–ª–µ–¥—É—é—â–∏–π —à–∞–≥ (release)
          echo "RELEASE_TAG=$TAG" >> $GITHUB_OUTPUT
        env:
          NODE_AUTH_TOKEN: ${{ secrets.NPM_TOKEN }}

      # 7. –°–æ–∑–¥–∞—ë–º —Å–∞–º GitHub Release (Draft: false ‚Üí —Å—Ä–∞–∑—É –ø—É–±–ª–∏—á–Ω—ã–π —Ä–µ–ª–∏–∑)
      - name: Create GitHub Release
        if: steps.check_bump.outputs.should_publish == 'true'
        uses: actions/create-release@v1
        with:
          tag_name: ${{ steps.publish-and-release.outputs.RELEASE_TAG }}
          release_name: "Release ${{ steps.publish-and-release.outputs.RELEASE_TAG }}"
          body: |
            üéâ –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∞—è —Å–±–æ—Ä–∫–∞ –∏ —Ä–µ–ª–∏–∑ –¥–ª—è –≤–µ—Ä—Å–∏–∏ `${{ steps.publish-and-release.outputs.RELEASE_TAG }}`
            - –°–æ–¥–µ—Ä–∂–∏–º–æ–µ changelog –∏–ª–∏ –ø—Ä–∏–º–µ—á–∞–Ω–∏—è –º–æ–∂–Ω–æ —Ç—É—Ç –ø–æ–¥—Å—Ç–∞–≤–∏—Ç—å –≤—Ä—É—á–Ω—É—é –∏–ª–∏ —á–µ—Ä–µ–∑ —á—Ç–µ–Ω–∏–µ —Ñ–∞–π–ª–∞
          draft: false
          prerelease: false
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
