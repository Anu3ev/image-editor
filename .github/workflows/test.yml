name: ğŸ§ª Tests & Quality Checks

# Workflow Ğ´Ğ»Ñ Ğ·Ğ°Ğ¿ÑƒÑĞºĞ° Ñ‚ĞµÑÑ‚Ğ¾Ğ² Ğ½Ğ° Ñ€Ğ°Ğ·Ğ½Ñ‹Ñ… Ğ²ĞµÑ€ÑĞ¸ÑÑ… Node.js
on:
  pull_request:
    branches: [ master, main ]  # Ğ¢ĞµÑÑ‚Ğ¸Ñ€ÑƒĞµĞ¼ Ñ‚Ğ¾Ğ»ÑŒĞºĞ¾ PR Ğ² Ğ¾ÑĞ½Ğ¾Ğ²Ğ½Ñ‹Ğµ Ğ²ĞµÑ‚ĞºĞ¸
  push:
    branches: [ master, main ]  # ĞŸÑ€Ğ¾Ğ²ĞµÑ€ÑĞµĞ¼ ĞºĞ°Ñ‡ĞµÑÑ‚Ğ²Ğ¾ Ñ‚Ğ¾Ğ»ÑŒĞºĞ¾ Ğ¾ÑĞ½Ğ¾Ğ²Ğ½Ñ‹Ñ… Ğ²ĞµÑ‚Ğ¾Ğº Ğ¿Ğ¾ÑĞ»Ğµ Ğ¼ĞµÑ€Ğ¶Ğ°

permissions:
  contents: read
  statuses: write
  issues: write
  pull-requests: write

jobs:
  test:
    name: "ğŸ”¬ Test on Node.js ${{ matrix.node-version }}"
    runs-on: ubuntu-latest

    strategy:
      matrix:
        node-version: [20]  # Ğ¢Ğ¾Ğ»ÑŒĞºĞ¾ Ğ°ĞºÑ‚ÑƒĞ°Ğ»ÑŒĞ½Ğ°Ñ LTS Ğ²ĞµÑ€ÑĞ¸Ñ
      fail-fast: false  # ĞĞµ Ğ¾ÑÑ‚Ğ°Ğ½Ğ°Ğ²Ğ»Ğ¸Ğ²Ğ°ĞµĞ¼ Ğ´Ñ€ÑƒĞ³Ğ¸Ğµ Ğ²ĞµÑ€ÑĞ¸Ğ¸ Ğ¿Ñ€Ğ¸ Ğ¿Ğ°Ğ´ĞµĞ½Ğ¸Ğ¸ Ğ¾Ğ´Ğ½Ğ¾Ğ¹

    steps:
      - name: "ğŸ“¥ Checkout repository"
        uses: actions/checkout@v4

      - name: "ğŸ”§ Setup Node.js ${{ matrix.node-version }}"
        uses: actions/setup-node@v4
        with:
          node-version: ${{ matrix.node-version }}
          cache: 'npm'

      - name: "ğŸ“¦ Install dependencies"
        run: |
          echo "ğŸ” Installing npm dependencies for Node.js ${{ matrix.node-version }}"
          npm ci
          echo "âœ… Dependencies installed successfully"

      - name: "ğŸ” Run ESLint code quality check"
        run: |
          echo "ğŸ” Running ESLint on src/**/*.{js,ts} files"
          npm run lint
          echo "âœ… Code quality check passed"

      - name: "ğŸ§ª Run tests with coverage"
        run: |
          echo "ğŸ§ª Running Jest tests with coverage on Node.js ${{ matrix.node-version }}"
          echo "ğŸ“Š Test files pattern: specs/**/*.{test,spec}.ts"
          npm run test:ci
          echo "âœ… All tests passed successfully"

      - name: "ğŸ“Š Generate detailed coverage report"
        if: matrix.node-version == 20  # Ğ“ĞµĞ½ĞµÑ€Ğ¸Ñ€ÑƒĞµĞ¼ Ğ´ĞµÑ‚Ğ°Ğ»ÑŒĞ½Ñ‹Ğ¹ Ğ¾Ñ‚Ñ‡Ñ‘Ñ‚ Ñ‚Ğ¾Ğ»ÑŒĞºĞ¾ Ğ´Ğ»Ñ Ğ¾Ğ´Ğ½Ğ¾Ğ¹ Ğ²ĞµÑ€ÑĞ¸Ğ¸
        run: |
          echo "ğŸ“Š Generating detailed coverage report for artifacts"
          npm run test:coverage
          echo "âœ… Coverage report generated"

      - name: "ğŸ“¤ Upload coverage artifacts"
        if: matrix.node-version == 20
        uses: actions/upload-artifact@v4
        with:
          name: "coverage-report-node${{ matrix.node-version }}"
          path: coverage/
          retention-days: 30

      - name: "ğŸ’¬ Post PR comment with results"
        if: github.event_name == 'pull_request' && matrix.node-version == 20
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');

            console.log('ğŸ“ Preparing PR comment with test results...');

            const nodeVersion = '${{ matrix.node-version }}';
            const emoji = 'âœ…';

            let comment = `${emoji} **Ğ ĞµĞ·ÑƒĞ»ÑŒÑ‚Ğ°Ñ‚Ñ‹ Ñ‚ĞµÑÑ‚Ğ¸Ñ€Ğ¾Ğ²Ğ°Ğ½Ğ¸Ñ Ğ½Ğ° Node.js ${nodeVersion}**\n\n`;
            comment += 'ğŸ‰ Ğ’ÑĞµ Ñ‚ĞµÑÑ‚Ñ‹ Ğ¿Ñ€Ğ¾ÑˆĞ»Ğ¸ ÑƒÑĞ¿ĞµÑˆĞ½Ğ¾!\n\n';

            // Ğ”Ğ¾Ğ±Ğ°Ğ²Ğ»ÑĞµĞ¼ Ğ¸Ğ½Ñ„Ğ¾Ñ€Ğ¼Ğ°Ñ†Ğ¸Ñ Ğ¾ Ğ¿Ğ¾ĞºÑ€Ñ‹Ñ‚Ğ¸Ğ¸
            try {
              const coverageExists = fs.existsSync('coverage/coverage-summary.json');
              if (coverageExists) {
                console.log('ğŸ“Š Reading coverage summary...');
                const coverage = JSON.parse(fs.readFileSync('coverage/coverage-summary.json', 'utf8'));
                const total = coverage.total;

                comment += 'ğŸ“Š **ĞŸĞ¾ĞºÑ€Ñ‹Ñ‚Ğ¸Ğµ ĞºĞ¾Ğ´Ğ°:**\n';
                comment += `- ğŸ“ Ğ¡Ñ‚Ñ€Ğ¾ĞºĞ¸: ${total.lines.pct}%\n`;
                comment += `- âš¡ Ğ¤ÑƒĞ½ĞºÑ†Ğ¸Ğ¸: ${total.functions.pct}%\n`;
                comment += `- ğŸŒ¿ Ğ’ĞµÑ‚ĞºĞ¸: ${total.branches.pct}%\n`;
                comment += `- âœ¨ Ğ£Ñ‚Ğ²ĞµÑ€Ğ¶Ğ´ĞµĞ½Ğ¸Ñ: ${total.statements.pct}%\n\n`;

                comment += `ğŸ”— [Ğ¡ĞºĞ°Ñ‡Ğ°Ñ‚ÑŒ Ğ¿Ğ¾Ğ»Ğ½Ñ‹Ğ¹ Ğ¾Ñ‚Ñ‡Ñ‘Ñ‚ Ğ¾ Ğ¿Ğ¾ĞºÑ€Ñ‹Ñ‚Ğ¸Ğ¸](https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }})\n\n`;
              }
            } catch (e) {
              console.log('âš ï¸ Coverage info not available:', e.message);
            }

            comment += '---\n';
            comment += `ğŸ¤– ĞŸÑ€Ğ¾Ñ‚ĞµÑÑ‚Ğ¸Ñ€Ğ¾Ğ²Ğ°Ğ½Ğ¾ Ğ½Ğ° Node.js ${nodeVersion} | â±ï¸ ${new Date().toLocaleString('ru-RU')}`;

            console.log('ğŸ’¬ Posting comment to PR...');

            await github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: comment
            });

            console.log('âœ… PR comment posted successfully');

      - name: "ğŸ·ï¸ Create commit status"
        if: always()
        uses: actions/github-script@v7
        with:
          script: |
            const jobStatus = '${{ job.status }}';
            const nodeVersion = '${{ matrix.node-version }}';

            console.log(`ğŸ“Š Job status: ${jobStatus} for Node.js ${nodeVersion}`);

            const state = jobStatus === 'success' ? 'success' : 'failure';
            const description = jobStatus === 'success'
              ? `âœ… Tests passed on Node.js ${nodeVersion}`
              : `âŒ Tests failed on Node.js ${nodeVersion}`;

            console.log(`ğŸ·ï¸ Creating commit status: ${state} - ${description}`);

            await github.rest.repos.createCommitStatus({
              owner: context.repo.owner,
              repo: context.repo.repo,
              sha: context.sha,
              state: state,
              target_url: `https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }}`,
              description: description,
              context: `tests/node-${nodeVersion}`
            });

            console.log('âœ… Commit status created successfully');
