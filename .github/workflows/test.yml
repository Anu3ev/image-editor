name: 🧪 Tests & Quality Checks

# Workflow для запуска тестов на разных версиях Node.js
on:
  pull_request:
    branches: [ master, main ]  # Тестируем только PR в основные ветки
  push:
    branches: [ master, main ]  # Проверяем качество только основных веток после мержа

permissions:
  contents: read
  statuses: write
  issues: write
  pull-requests: write

jobs:
  test:
    name: "🔬 Test on Node.js ${{ matrix.node-version }}"
    runs-on: ubuntu-latest

    strategy:
      matrix:
        node-version: [20]  # Только актуальная LTS версия
      fail-fast: false  # Не останавливаем другие версии при падении одной

    steps:
      - name: "📥 Checkout repository"
        uses: actions/checkout@v4

      - name: "🔧 Setup Node.js ${{ matrix.node-version }}"
        uses: actions/setup-node@v4
        with:
          node-version: ${{ matrix.node-version }}
          cache: 'npm'

      - name: "📦 Install dependencies"
        run: |
          echo "🔍 Installing npm dependencies for Node.js ${{ matrix.node-version }}"
          npm ci
          echo "✅ Dependencies installed successfully"

      - name: "🔍 Run ESLint code quality check"
        run: |
          echo "🔍 Running ESLint on src/**/*.{js,ts} files"
          npm run lint
          echo "✅ Code quality check passed"

      - name: "🧪 Run tests with coverage"
        id: run-tests
        run: |
          echo "🧪 Running Jest tests with coverage on Node.js ${{ matrix.node-version }}"
          echo "📊 Test files pattern: specs/**/*.{test,spec}.ts"
          npm run test:ci
          echo "✅ All tests passed successfully"
        continue-on-error: true

      - name: "📊 Generate detailed coverage report"
        if: steps.run-tests.outcome == 'success' && matrix.node-version == 20
        run: |
          echo "📊 Generating detailed coverage report for artifacts"
          npm run test:coverage
          echo "✅ Coverage report generated"

      - name: "📤 Upload coverage artifacts"
        if: steps.run-tests.outcome == 'success' && matrix.node-version == 20
        uses: actions/upload-artifact@v4
        with:
          name: "coverage-report-node${{ matrix.node-version }}"
          path: coverage/
          retention-days: 30

      - name: "💬 Update PR comment with results"
        if: github.event_name == 'pull_request' && matrix.node-version == 20 && always()
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');

            console.log('📝 Preparing PR comment with test results...');

            const nodeVersion = '${{ matrix.node-version }}';
            const testResult = '${{ steps.run-tests.outcome }}';
            const emoji = testResult === 'success' ? '✅' : '❌';

            let comment = `${emoji} **Результаты тестирования на Node.js ${nodeVersion}**\n\n`;

            if (testResult === 'success') {
              comment += '🎉 Все тесты прошли успешно!\n\n';

              // Добавляем информацию о покрытии
              try {
                const coverageExists = fs.existsSync('coverage/coverage-summary.json');
                if (coverageExists) {
                  console.log('📊 Reading coverage summary...');
                  const coverage = JSON.parse(fs.readFileSync('coverage/coverage-summary.json', 'utf8'));
                  const total = coverage.total;

                  comment += '📊 **Покрытие кода:**\n';
                  comment += `- 📝 Строки: ${total.lines.pct}%\n`;
                  comment += `- ⚡ Функции: ${total.functions.pct}%\n`;
                  comment += `- 🌿 Ветки: ${total.branches.pct}%\n`;
                  comment += `- ✨ Утверждения: ${total.statements.pct}%\n\n`;

                  comment += `🔗 [Скачать полный отчёт о покрытии](https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }})\n\n`;
                }
              } catch (e) {
                console.log('⚠️ Coverage info not available:', e.message);
              }
            } else {
              comment += '💥 Некоторые тесты упали!\n\n';
              comment += '⚠️ **Внимание**: Мерж заблокирован до исправления тестов.\n\n';
              comment += `🔗 [Посмотреть детали ошибки](https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }})\n\n`;
            }

            comment += '---\n';
            comment += `🤖 Протестировано на Node.js ${nodeVersion} | ⏱️ ${new Date().toLocaleString('ru-RU')}`;

            console.log('💬 Looking for existing comment to update...');

            // Ищем существующий комментарий для обновления
            const { data: comments } = await github.rest.issues.listComments({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
            });

            const botComment = comments.find(comment =>
              comment.user.type === 'Bot' &&
              comment.body.includes('Результаты тестирования на Node.js')
            );

            if (botComment) {
              console.log('🔄 Updating existing comment...');
              await github.rest.issues.updateComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                comment_id: botComment.id,
                body: comment
              });
              console.log('✅ Comment updated successfully');
            } else {
              console.log('📝 Creating new comment...');
              await github.rest.issues.createComment({
                issue_number: context.issue.number,
                owner: context.repo.owner,
                repo: context.repo.repo,
                body: comment
              });
              console.log('✅ New comment created successfully');
            }

      - name: "🏷️ Create commit status"
        if: always()
        uses: actions/github-script@v7
        with:
          script: |
            const testResult = '${{ steps.run-tests.outcome }}';
            const nodeVersion = '${{ matrix.node-version }}';

            console.log(`📊 Test result: ${testResult} for Node.js ${nodeVersion}`);

            const state = testResult === 'success' ? 'success' : 'failure';
            const description = testResult === 'success'
              ? `✅ Tests passed on Node.js ${nodeVersion}`
              : `❌ Tests failed on Node.js ${nodeVersion}`;

            console.log(`🏷️ Creating commit status: ${state} - ${description}`);

            await github.rest.repos.createCommitStatus({
              owner: context.repo.owner,
              repo: context.repo.repo,
              sha: context.sha,
              state: state,
              target_url: `https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }}`,
              description: description,
              context: `tests/node-${nodeVersion}`
            });

            console.log('✅ Commit status created successfully');
